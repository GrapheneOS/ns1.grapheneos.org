#!/bin/bash

set -o errexit -o nounset -o pipefail
shopt -s expand_aliases

. servers.sh

alias rsync='rsync --fsync --preallocate'

for server in ${servers[@]}; do
    echo $server

    remote=root@$server

    # handled by yto.grapheneos.org host for now
    [[ $server == yto.ns2.grapheneos.org ]] && continue

    if [[ $server == *.ns1.grapheneos.org ]]; then
        subdomain=ns1
    else
        subdomain=ns2
    fi

    subdomain=staging

    ssh $remote 'id -u bird &>/dev/null || useradd -r bird -d /'
    rsync -rpcv --chmod=D755,F644 systemd/system/bird.service.d $remote:/etc/systemd/system/
    rsync -pcv --chmod=644 bird.$subdomain.conf $remote:/etc/bird.conf
    cp bird.$server.conf bird.local.conf
    sed -i "s/{{bgp_password}}/${bgp_password[$server]}/g" bird.local.conf
    rsync -pcv --chmod=644 bird.local.conf $remote:/etc/bird.local.conf
    rm bird.local.conf

    echo
done
