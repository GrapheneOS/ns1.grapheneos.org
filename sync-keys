#!/bin/bash

set -o errexit -o nounset -o pipefail

. servers.sh

rsync -rcv --fsync --preallocate root@0.ns1.grapheneos.org:/etc/powerdns/keys/ keys

for server in ${servers[@]:1}; do
    echo $server

    remote=root@$server

    rsync -rcpv --delete --chmod=D750,F640 --chown=root:powerdns --fsync --preallocate keys/ root@$server:/etc/powerdns/keys
    rsync -pcv --chmod=755 --fsync --preallocate pdns-dnssec-setup $remote:/usr/local/bin/pdns-dnssec-setup
    ssh $remote pdns-dnssec-setup

    echo
done
